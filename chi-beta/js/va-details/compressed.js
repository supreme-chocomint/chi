function collectVADetails(a){let b=a.data.Staff,c={roles:[],id:b.id,name:parsedName(b.name),language:b.language,url:b.siteUrl,image:b.image.large,popularity:b.favourites,numCorruptRoles:0,numOrphanRoles:0,toFixCount:0};window.voiceActors[c.id]=c,extractVARoles(a)}function extractVARoles(a){let b=a.data.Staff,c=b.characters.edges,d=window.voiceActors[b.id];for(let b of c){let c=getMainShowofCharacter(b);if(null==c){let c={id:b.node.id};makeRequest(getQuery("CHARACTER ID"),c,function(b){addAniListCorruptRoles(a,b)}),d.toFixCount++,d.numCorruptRoles++}else{let a={id:b.node.id,favourites:b.node.favourites,name:parsedName(b.node.name),url:b.node.siteUrl,image:b.node.image.large,characterRole:b.role};d.roles.push({show:c,character:a})}}0==d.toFixCount?decideNextStep(a):console.log(`${d.name} - corrupt roles to fix: ${d.toFixCount}`)}function getMainShowofCharacter(a){let b=0,c=a.media[0];for(let d of a.media)d.popularity>b&&(b=d.popularity,c=d);return c}function addAniListCorruptRoles(a,b){let c,d,e,f=a.data.Staff.id,g=b.data.Character;try{c={characterRole:g.media.edges[0].characterRole,id:g.id,favourites:g.favourites,name:parsedName(g.name),url:g.siteUrl,image:g.image.large},d=g.media.nodes[0],e={show:d,character:c},window.voiceActors[f].roles.push(e)}catch(a){console.log("Character data for "+g.id+"/"+parsedName(g.name)+" unrecoverable."),window.voiceActors[f].numOrphanRoles+=1}window.voiceActors[f].toFixCount--,0==window.voiceActors[f].toFixCount&&decideNextStep(a)}function requestNextVaPage(a){let b=a.data.Staff,c=b.characters.pageInfo.currentPage+1,d=b.characters.pageInfo.lastPage,e={id:b.id,pageNum:c};makeRequest(getQuery("VA ID"),e,extractVARoles),displayPageProgress(c,d)}function decideNextStep(a){if(1==a.data.Staff.characters.pageInfo.currentPage)if(0!=a.data.Staff.characters.edges.length)fillVaBasicInfo(window.voiceActors[a.data.Staff.id]);else return unsetFetchingDetails(),void addNotVaIndicator();a.data.Staff.characters.pageInfo.hasNextPage?requestNextVaPage(a):(fillVaAdvancedInfo(window.voiceActors[a.data.Staff.id]),unsetFetchingDetails())}function calculateStatistics(a){let b=window.voiceActors[a];b.rolesCount=b.roles.length,b.roleMostPopularShow=getRoleByHighestShowMetric("popularity",b.roles),b.roleHighestRatedShow=getRoleByHighestShowMetric("meanScore",b.roles),b.avgCharacterPopularity=getAvgCharacterPopularity(b),b.characterSpread=getCharacterSignificanceSpread(b.roles)}function getRoleByHighestShowMetric(a,b){let c=0,d=b[0];for(let e of b)e.show[a]>c&&(c=e.show[a],d=e);return d}function getAvgCharacterPopularity(a){null==a.characterSpread&&(a.characterSpread=getCharacterSignificanceSpread(a.roles));let b=0,c=0;for(let d of a.roles)"MAIN"==d.character.characterRole&&(c+=d.character.favourites),b+=d.character.favourites;return c=0==c?0:Math.round(c/a.characterSpread.MAIN),b=0==b?0:Math.round(b/a.rolesCount),{main:c,total:b}}function getCharacterSignificanceSpread(a){let b=0,c=0;for(let d of a)"MAIN"==d.character.characterRole?b+=1:c+=1;return{MAIN:b,SUPPORTING:c}}function addPopularCharacters(a,b){let c=a.roles.slice();sortRolesByFavourites(c),a.popularRoles=[];let d=0;for(role of c)if(30<=role.character.favourites&&(a.popularRoles.push(role),d++),d==b)break}function addUwCharacters(a,b){let c=a.roles.slice();sortRolesByShowPopularity(c),c.reverse(),c=c.filter(function(b){return!a.popularRoles.includes(b)&&!(3e4<=b.show.popularity)&&(!("MAIN"!=b.character.characterRole)||!(10>=b.character.favourites))});let d,e=[80,77,75,72,70],f=0;for(;f!=e.length&&(d=c.filter(a=>a.show.meanScore>=e[f]),!(d.length>=b));)f++;a.uwRoles=d.slice(0,b),sortRolesByShowRating(a.uwRoles)}function sortRolesByFavourites(a){a.sort(function(c,a){return a.character.favourites-c.character.favourites})}function sortRolesByShowPopularity(a){a.sort(function(c,a){return a.show.popularity-c.show.popularity})}function sortRolesByShowRating(a){a.sort(function(c,a){return a.show.meanScore-c.show.meanScore})}function buildVaDetailsTab(a){let b=document.getElementById("main-container"),c=document.getElementById("va-info-container"),d=document.getElementById("va-left-container"),e=document.getElementById("va-right-container"),f=document.getElementById("all-characters-switch"),g=document.getElementById("display-mode-switch"),h=window.voiceActors[a];if(isFetchingDetails()){let d=getFetchingDetailsId();d==a&&(b.style.display="none",c.style.display="")}else setFetchingDetails(a),b.style.display="none",c.style.display="",f.classList.add("disabled"),clearVaInfo(),h&&h.roles&&0!=h.roles.length?(fillVaBasicInfo(window.voiceActors[a]),fillVaAdvancedInfo(window.voiceActors[a]),unsetFetchingDetails()):(document.getElementById("va-info-bio-text").innerHTML="Getting initial data...",makeRequest(getQuery("VA ID"),{id:a,pageNum:1},collectVADetails))}function fillVaBasicInfo(a){let b=document.getElementById("va-info-name"),c=document.getElementById("va-info-bio-portrait"),d=document.getElementById("va-info-bio-text"),e=document.createElement("h4"),f=document.getElementById("va-left-container"),g=document.getElementById("va-side-containers");e.innerHTML=a.name,b.appendChild(e),document.title=a.name+" - "+document.baseTitle,c.style.backgroundImage=`url(${a.image})`,c.classList.add("thumbnail");if(addPopularCharacters(a,6),0!=a.popularRoles.length){for(let b of a.popularRoles)addCharacterEntry("va-popular-characters",b);f.style.display=""}g.style.display=""}function displayPageProgress(a,b){document.getElementById("va-info-bio-text").innerHTML=`Getting data: page ${a} of ${b}`}function addNotVaIndicator(){document.getElementById("va-info-bio-text").innerHTML="Selected person has no known voice acting roles."}function fillVaAdvancedInfo(a){let b=document.getElementById("va-info-bio-portrait"),c=document.getElementById("va-info-bio-text"),d=document.createElement("a"),e=document.getElementById("va-left-container"),f=document.getElementById("va-right-container"),g=document.getElementById("va-bottom-container"),h=document.getElementById("display-mode-switch");30<a.numCorruptRoles?(window.alert(getVaFragmentationErrorString()),c.innerHTML=getVaFragmentationNoticeString()+"<br>"):c.innerHTML="",sortRolesByFavourites(a.roles),calculateStatistics(a.id),c.innerHTML+=formatStats(a),d.href=a.url,d.target="_blank",d.innerHTML="View on AniList",c.appendChild(d);if(addUwCharacters(a,6),0!=a.uwRoles.length)for(let b of a.uwRoles)addCharacterEntry("va-uw-characters",b);for(role of a.roles)"MAIN"==role.character.characterRole?addCharacterEntry("va-main-characters",role):addCharacterEntry("va-support-characters",role);resizeCharacterContainers(a)}function resizeCharacterContainers(a){let b=document.getElementById("va-left-container"),c=document.getElementById("va-right-container"),d=document.getElementById("va-bottom-container"),e=document.getElementById("all-characters-switch");0==a.uwRoles.length&&0==a.popularRoles.length?(b.style.display="none",c.style.display="none",d.style.display=""):0==a.uwRoles.length&&0!=a.popularRoles.length?(c.style.display="none",changeSideContainerWidths("natural"),e.classList.remove("disabled")):0==a.popularRoles.length&&0!=a.uwRoles.length?(b.style.display="none",c.style.display="",changeSideContainerWidths("natural"),e.classList.remove("disabled")):(c.style.display="",e.classList.remove("disabled"))}function changeSideContainerWidths(a){let b=document.getElementById("va-left-container"),c=document.getElementById("va-right-container");switch(a){case"natural":b.classList.remove("one-half"),b.classList.remove("column"),c.classList.remove("one-half"),c.classList.remove("column");break;case"half":b.classList.add("one-half"),b.classList.add("column"),c.classList.add("one-half"),c.classList.add("column");break;default:}}function formatStats(a){let b=a.roleMostPopularShow,c=a.roleHighestRatedShow,d=`
  Popularity: ${a.popularity} favorites<br>
  Number of characters voiced: ${a.rolesCount}<br>

  Most popular show: <a href="${b.show.siteUrl}" target="_blank">
  ${b.show.title.romaji}</a>
    (voiced <a href="${b.character.url}" target="_blank">
    ${b.character.name}</a>)<br>

  Highest rated show: <a href="${c.show.siteUrl}" target="_blank">
  ${c.show.title.romaji}</a>
      (voiced <a href="${c.character.url}" target="_blank">
      ${c.character.name}</a>)<br>

  Mean character popularity:
    ${a.avgCharacterPopularity.main} favorites for main characters,
    ${a.avgCharacterPopularity.total} favorites for all characters<br>
  Character spread:
    ${a.characterSpread.MAIN} main,
    ${a.characterSpread.SUPPORTING} supporting
    <br>
  `;return d}function addCharacterEntry(a,b){window.currentDisplay.addCharacterEntry(a,b)}function addCharacterTableEntry(a,b){let c=b.character,d=b.show,e=document.getElementById(a),f=document.createElement("tr"),g=document.createElement("td"),h=document.createElement("img"),i=document.createElement("td"),j=document.createElement("a"),k=document.createElement("a");h.src=c.image,h.alt=c.name,g.appendChild(h),f.appendChild(g),j.href=c.url,j.target="_blank",j.innerHTML=c.name,k.href=d.siteUrl,k.target="_blank",k.innerHTML=d.title.romaji,i.appendChild(j),i.innerHTML+="<br>",i.appendChild(k),f.appendChild(i),e.appendChild(f)}function clearVaInfo(){document.getElementById("va-info-name").innerHTML="",document.getElementById("va-info-bio-portrait").style.backgroundImage="",document.getElementById("va-info-bio-portrait").classList.remove("thumbnail"),document.getElementById("va-info-bio-text").innerHTML="",document.getElementById("va-left-container").style.display="none",document.getElementById("va-right-container").style.display="none",document.getElementById("va-bottom-container").style.display="none",window.currentDisplay.clearSideContainers(),window.currentDisplay.clearBottomContainer(),changeSideContainerWidths("half"),changeSideContainerWidths("half")}function VADetailsOnClick(a){window.location.hash=a}function returnButtonOnClick(){window.location.hash=""}function allCharactersSwitchOnClick(){let a=document.getElementById("va-side-containers"),b=document.getElementById("va-bottom-container");"none"==b.style.display?(b.style.display="",a.style.display="none"):(a.style.display="",b.style.display="none")}function portraitThumbnailOnClick(a){let b=a.parentNode.children[1].children[0];b.lastChild.click()}function characterThumbnailOnClick(a){a.nextSibling.firstChild.click()}function isFetchingDetails(){let a=document.getElementById("va-info-container").getAttribute("data-fetching");return null!=a&&0!=a}function setFetchingDetails(a){document.getElementById("va-info-container").setAttribute("data-fetching",a),document.getElementById("fetch-icon").innerHTML="\u30A2",document.getElementById("fetch-icon").style.display=""}function unsetFetchingDetails(){document.getElementById("va-info-container").setAttribute("data-fetching",0),document.getElementById("fetch-icon").innerHTML="",document.getElementById("fetch-icon").style.display="none"}function getFetchingDetailsId(){let a=document.getElementById("va-info-container").getAttribute("data-fetching");return null==a?0:a}